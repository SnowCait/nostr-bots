import { getEventHash, getPublicKey, getSignature, nip19 } from 'nostr-tools';
import 'websocket-polyfill'

const nsecKey = 'nostr-test-bot-nsec';

export const handler = async (e) => {
  console.log('[request]', JSON.stringify(e))
  const json = e.isBase64Encoded ? Buffer.from(e.body, 'base64').toString() : e.body
  console.log('[request event]', json)

  const requestEvent = JSON.parse(json)

  const nsec = await getNsec(nsecKey)
  const { type, data: seckey } = nip19.decode(nsec)

  if (type !== 'nsec' || typeof seckey !== 'string') {
    throw new Error(`[invalid nsec] type: ${type}, typeof seckey: ${typeof seckey}`)
  }

  const pubkey = getPublicKey(seckey)

  const tiles = true
    ? 'ğŸ€‡ğŸ€ˆğŸ€‰ğŸ€ŠğŸ€‹ğŸ€ŒğŸ€ğŸ€ğŸ€ğŸ€ğŸ€‘ğŸ€’ğŸ€“ğŸ€”ğŸ€•ğŸ€–ğŸ€—ğŸ€˜ğŸ€™ğŸ€šğŸ€›ğŸ€œğŸ€ğŸ€ğŸ€ŸğŸ€ ğŸ€¡ğŸ€€ğŸ€ğŸ€‚ğŸ€ƒğŸ€†ğŸ€…ğŸ€„'.repeat(4)
    : 'ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹â‘ â‘¡â‘¢â‘£â‘¤â‘¥â‘¦â‘§â‘¨ï¼‘ï¼’ï¼“ï¼”ï¼•ï¼–ï¼—ï¼˜ï¼™æ±å—è¥¿åŒ—ç™½ç™¼ä¸­'.repeat(4);
  const wall = [...tiles];
  shuffle(wall);
  console.log('[wall]', wall);
  const hand = wall.slice(0, 14);
  hand.sort();
  console.log('[hand]', hand);

  const event = {
    kind: 1,
    created_at: Math.floor(Date.now() / 1000),
    tags: [
      ['e', requestEvent.id, '', 'root'],
      ['p', requestEvent.pubkey]
    ],
    content: hand.join(''),
    pubkey
  }

  event.id = getEventHash(event)
  event.sig = getSignature(event, seckey)
  console.log('[event]', event)

  return {
    statusCode: 200,
    body: JSON.stringify(event)
  };
};

function shuffle(array) {
  for (let i = array.length - 1; i > 0; i--) {
    let j = Math.floor(Math.random() * (i + 1)); // 0 ã‹ã‚‰ i ã®ãƒ©ãƒ³ãƒ€ãƒ ãªã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
    [array[i], array[j]] = [array[j], array[i]]; // è¦ç´ ã‚’å…¥ã‚Œæ›¿ãˆã¾ã™
  }
}

async function getNsec (name) {
  const response = await fetch(`http://localhost:2773/systemsmanager/parameters/get?name=${name}&withDecryption=true`, {
    method: 'GET',
    headers: {
      'X-Aws-Parameters-Secrets-Token': process.env.AWS_SESSION_TOKEN
    }
  })

  if (!response.ok) {
    throw new Error(await response.text())
  }

  const secrets = await response.json()
  return secrets.Parameter.Value
}
